<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title th:text="${device.name} + ' - Device Detail'">Device Detail</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --green-900: #0b5d43;   
            --green-700: #2b7a54;   
            --green-400: #3e9f78;   
            --green-200: #e8f5ef;   
            --green-100: #f4fbf7;   
            --text-900: #1f3c2e;
        }

        body {
            background: #fff;
            color: var(--text-900);
            font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        }

        
        .page-title {
            font-weight: 800;
            color: var(--green-700);
        }

        
        .metric {
            background: var(--green-900);
            border-radius: 14px;
            overflow: hidden;
            height: 100%;
            color: #fff;
        }

        .metric-head {
            background: var(--green-700);
            color: #fff;
            font-weight: 700;
            font-size: .95rem;
            border-radius: 10px;
            padding: 8px 14px;
            display: inline-block;
            margin-bottom: 10px;
        }

        .metric-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
        }

        .metric-body {
            padding: 12px 14px 18px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 800;
            margin: 0;
        }

        
        .action-row .btn {
            font-weight: 700;
            border-radius: 12px;
            padding: 12px 14px;
            border: none;
        }

        .btn-green {
            background: var(--green-700);
            color: #fff;
        }

        .btn-green:hover {
            background: #256546;
            color: #fff;
        }

        .btn-emerald {
            background: #16866a;
            color: #fff;
        }

        .btn-emerald:hover {
            background: #12755d;
            color: #fff;
        }

        
        .iot-panel {
            background: var(--green-100);
            border: 2px solid var(--green-700);
            border-radius: 14px;
            padding: 16px;
            transition: all 0.3s ease;
        }

        .subnote {
            color: #6b7d73;
            font-size: .9rem;
        }

        
        .mode-header {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--green-900);
            color: #fff;
            font-weight: 700;
            border-radius: 10px;
            padding: 10px 14px;
        }

        .mode-title {
            font-family: "Poppins", sans-serif;
            font-weight: 600;
            font-size: 1rem;
        }

        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
            flex-shrink: 0;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            inset: 0;
            cursor: pointer;
            background-color: #bcbcbc;
            border-radius: 34px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        input:checked + .slider {
            background-color: #1cc85a;
            box-shadow: 0 0 8px rgba(28, 200, 90, 0.6);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        
        .mode-body {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.4s ease, opacity 0.3s ease;
        }

        .mode-body.show {
            opacity: 1;
            max-height: 1000px; 
        }

        
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: var(--green-200);
            color: var(--text-900);
            border: 1px solid var(--green-700);
            border-radius: 999px;
            padding: 8px 12px;
            font-weight: 700;
        }

        .pill input {
            max-width: 72px;
            border: 1px solid #cfe9dd;
            background: #fff;
            border-radius: 8px;
            padding: 2px 8px;
            text-align: center;
        }

        
        .chart-wrap {
            background: var(--green-100);
            border: 2px solid var(--green-700);
            border-radius: 14px;
            padding: 16px;
        }

        .chart-title {
            font-weight: 700;
            color: var(--green-700);
        }

        .table thead th {
            background: var(--green-200);
        }

        
        .navbar-custom {
            background-color: var(--green-900) !important;
            padding: 0.75rem 1rem;
        }

        .navbar-custom .nav-link {
            color: #d6e5da !important;
            font-weight: 400;
            margin-right: 1.2rem;
            transition: 0.2s;
        }

        .navbar-custom .nav-link:hover {
            color: #ffffff !important;
        }

        .navbar-custom .nav-link.active {
            font-weight: 600;
            text-decoration: underline;
            text-underline-offset: 5px;
        }
    </style>

</head>

<body>
    
    <div th:replace="fragments/navbar :: navbar"></div>

    <div class="container my-4">

        
        <h2 class="page-title mb-3" th:text="'Perangkat ' + (${device.id}?:1) + ' : ' + (${device.name}?:'Tanaman Melon')">
            Perangkat 1 : Tanaman Melon
        </h2>

        
        <div class="row g-3 mb-3">
        <div class="col-12 col-md-4">
            <div class="metric">
            <div class="p-2"><span class="metric-head">Kelembaban Tanah</span></div>
           
            <div class="metric-body text-center">
                <p class="metric-value" th:text="${#lists.isEmpty(sensorData) ? '‚Äì %' : sensorData.get(0).soilMoisture + ' %'}">25 %</p>
            </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="metric">
            <div class="p-2"><span class="metric-head">Suhu Udara</span></div>
            
            <div class="metric-body text-center">
                <p class="metric-value" th:text="${#lists.isEmpty(sensorData) ? '‚Äì ¬∞C' : sensorData.get(0).airHumidity + ' ¬∞C'}">29 ¬∞C</p>
            </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="metric">
            <div class="p-2"><span class="metric-head">Intensitas Cahaya</span></div>
           
            <div class="metric-body text-center">
                <p class="metric-value" th:text="${#lists.isEmpty(sensorData) ? '‚Äì lux' : sensorData.get(0).lightIntensity + ' lux'}">30 lux</p>
            </div>
            </div>
        </div>
        </div>

        
        <div class="action-row d-flex flex-column flex-md-row gap-3 mb-4">
        <form th:action="@{'/api/device/' + ${device.id} + '/command'}" method="post" class="flex-fill">
            <input type="hidden" name="type" value="watering" />
            <input type="hidden" name="value" value="100" />
            <input type="hidden" name="override" value="true" />
            <input type="hidden" name="durationSeconds" value="60" />
            <button type="submit" class="btn btn-green w-100">üíß Tekan untuk siram selama 1 menit</button>
        </form>

        <form th:action="@{'/api/device/' + ${device.id} + '/command'}" method="post" class="flex-fill">
            <input type="hidden" name="type" value="lighting" />
            <input type="hidden" name="value" value="100" />
            <input type="hidden" name="override" value="true" />
            <input type="hidden" name="durationSeconds" value="60" />
            <button type="submit" class="btn btn-emerald w-100">‚ùÑÔ∏è Tekan untuk menyalakan lampu dengan durasi 1 menit</button>
        </form>
        </div>

        
        <p class="subnote mb-2">
            Mode IoT ‚Äî Ketika IoT baru aktif akan berada dalam Mode Otomatis. Kamu dapat mengubah ke Mode Pengaturan Pengguna
            untuk kostumisasi IoT.
        </p>

        
        <div class="iot-panel mb-3">
        <div class="mode-header">
            <label class="switch">
            <input type="checkbox" id="autoSwitch" checked />
            <span class="slider"></span>
            </label>
            <div class="mode-title"><span>Mode Otomatis</span></div>
        </div>

        <div id="autoBody" class="mode-body">
            <p>Pengguna tidak perlu khawatir terhadap keberlangsungan hidup tanaman.</p>
            <ul>
            <li>Pompa otomatis menyiram ketika:
                <ul class="mt-1">
                <li>Kelembaban tanah &lt; 10% dan akan berhenti di kelembaban tanah &gt; 50%</li>
                <li>Suhu udara &gt; 30¬∞C</li>
                </ul>
            </li>
            <li>Setiap 6 jam Led Growth Light akan menyala dengan durasi 1 jam.</li>
            </ul>
            <p class="mb-0">
            <strong>Notes:</strong> Pompa tidak akan menyiram ketika kelembaban tanah &gt; 80%
            untuk menghindari kebusukan akar.
            </p>
        </div>
        </div>

        
        <div class="iot-panel mb-4">
        <div class="mode-header">
            <label class="switch">
            <input type="checkbox" id="customSwitch" />
            <span class="slider"></span>
            </label>
            <div class="mode-title"><span>Mode Kustomisasi</span></div>
        </div>

        <div id="customBody" class="mode-body">
            <div class="d-flex flex-wrap gap-2 mb-2">
            <div class="pill">Kelembaban Tanah &lt; <input type="number" min="0" max="100" value="25" /> %</div>
            <div class="pill">Suhu Udara &gt; <input type="number" min="0" max="60" value="28" /> ¬∞C</div>
            <div class="pill">Intensitas Cahaya &lt; <input type="number" min="0" max="200000" value="150000" /> lux</div>
            </div>
            <p class="subnote mb-0">
            Notes: Pengguna dapat mengatur tanaman akan disiram pada kondisi tertentu. Mode ini dapat disesuaikan
            dengan umur, jenis, dan usia tanaman.
            </p>
        </div>
        <button id="saveSettingsBtn" class="btn btn-primary mt-2">Simpan Pengaturan</button>

        </div>




        
        <div class="chart-wrap mb-4">
            <h5 class="chart-title mb-2">Grafik Penyiraman dan Pencahayaan 7 Hari Ke Belakang</h5>
            <div style="height:320px;"><canvas id="sensorChart"></canvas></div>
        </div>

    </div>

    <div class="mt-5"></div>
    <div th:replace="fragments/footer :: footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script th:inline="javascript">
    /*<![CDATA[*/
    const sensorData = /*[[${sensorData}]]*/ [];
    /*]]>*/


    document.getElementById("saveSettingsBtn").addEventListener("click", () => {
        const deviceId = 1; 
        saveCustomSettings(deviceId);
    });

    document.addEventListener("DOMContentLoaded", () => {
        const ctx = document.getElementById("sensorChart").getContext("2d");

        if (!sensorData || sensorData.length === 0) {
            console.log("No sensor data available for chart");
            return;
        }

        const labels = sensorData.map(d => {
            const ts = new Date(d.timestamp);
            return ts.toLocaleString('id-ID', { 
                day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' 
            });
        }).reverse();

        const soilMoisture = sensorData.map(d => d.soilMoisture).reverse();
        const airHumidity = sensorData.map(d => d.airHumidity).reverse();
        const lightIntensity = sensorData.map(d => d.lightIntensity).reverse();

        new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "Soil Moisture (%)",
                        data: soilMoisture,
                        borderColor: "#2b7a54",
                        backgroundColor: "rgba(43, 122, 84, 0.2)",
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: "Air Humidity (%)",
                        data: airHumidity,
                        borderColor: "#1cc85a",
                        backgroundColor: "rgba(28, 200, 90, 0.2)",
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: "Light Intensity (lux)",
                        data: lightIntensity,
                        borderColor: "#eab308",
                        backgroundColor: "rgba(234, 179, 8, 0.2)",
                        fill: true,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: "top",
                        labels: { color: "#1f3c2e" }
                    }
                },
                scales: {
                    x: { ticks: { color: "#1f3c2e" } },
                    y: { ticks: { color: "#1f3c2e" } }
                }
            }
        });
    });
</script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {

       
        const autoSwitch = document.getElementById('autoSwitch');
        const customSwitch = document.getElementById('customSwitch');
        const autoBody = document.getElementById('autoBody');
        const customBody = document.getElementById('customBody');

        function toggleBody(isActive, el) {
            if (isActive) {
            el.classList.add('show');
            el.style.maxHeight = el.scrollHeight + "px";
            } else {
            el.style.maxHeight = el.scrollHeight + "px";
            requestAnimationFrame(() => {
                el.classList.remove('show');
                el.style.maxHeight = "0";
            });
            }
        }

        function syncModes(trigger) {
            if (trigger === 'auto' && autoSwitch.checked) {
            customSwitch.checked = false;
            } else if (trigger === 'custom' && customSwitch.checked) {
            autoSwitch.checked = false;
            }

            toggleBody(autoSwitch.checked, autoBody);
            toggleBody(customSwitch.checked, customBody);
        }

        autoSwitch.addEventListener('change', () => syncModes('auto'));
        customSwitch.addEventListener('change', () => syncModes('custom'));

        autoSwitch.addEventListener("change", () => {
            const manualMode = !autoSwitch.checked;  
           

            fetch(`/api/device/1/mode`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ manualMode })
            })
            .then(res => res.json())
            .then(data => console.log("Mode updated:", data))
            .catch(err => console.error("Error updating mode:", err));
        });

        customSwitch.addEventListener("change", () => {
            const manualMode = customSwitch.checked; 

            
            if (customSwitch.checked) {
                autoSwitch.checked = false;
            }

            fetch(`/api/device/1/mode`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ manualMode })
            })
            .then(res => res.json())
            .then(data => console.log("Mode updated:", data))
            .catch(err => console.error("Error updating mode:", err));
        });



        syncModes();


        const sensorData = /*[[${sensorData}]]*/ [];

            if (Array.isArray(sensorData) && sensorData.length > 0) {
                // Sort ascending by timestamp
                sensorData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                const labels = sensorData.map(d =>
                new Date(d.timestamp).toLocaleDateString('id-ID', { weekday: 'long' })
                );

                const soilMoisture = sensorData.map(d => d.soilMoisture);
                const lightIntensity = sensorData.map(d => d.lightIntensity);

                const ctx = document.getElementById("sensorChart").getContext("2d");
                new Chart(ctx, {
                type: "line",
                data: {
                    labels,
                    datasets: [
                    {
                        label: "Penyiraman (Kelembaban Tanah)",
                        data: soilMoisture,
                        fill: true,
                        borderColor: "rgba(54, 162, 235, 1)",
                        backgroundColor: "rgba(54, 162, 235, 0.2)",
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                    },
                    {
                        label: "Pencahayaan (Intensitas Cahaya)",
                        data: lightIntensity,
                        fill: true,
                        borderColor: "rgba(255, 206, 86, 1)",
                        backgroundColor: "rgba(255, 206, 86, 0.25)",
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                    }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                    legend: {
                        position: "top",
                        labels: { color: "#1f3c2e", font: { family: "Poppins" } }
                    }
                    },
                    scales: {
                    x: {
                        ticks: { color: "#1f3c2e", font: { family: "Poppins" } },
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: { color: "#1f3c2e" },
                        grid: { color: "rgba(0,0,0,0.05)" }
                    }
                    }
                }
            });
        }

        });


        function getCustomThresholds() {
    const inputs = customBody.querySelectorAll("input[type='number']");
    return {
        soilMin: parseInt(inputs[0].value),
        tempPump: parseInt(inputs[1].value),
        luxMin: parseInt(inputs[2].value)
        // Add soilMax, tempLightOff, luxMax, lightDuration, lightInterval if needed
    };
}

async function saveCustomSettings(deviceId) {
    if (!customSwitch.checked) {
        alert("Aktifkan Mode Kustomisasi terlebih dahulu!");
        return;
    }

    const payload = getCustomThresholds();

    try {
        const response = await fetch(`/api/device/${deviceId}/settings`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        if (data.status === "success") {
            alert("Pengaturan berhasil disimpan!");
        } else {
            alert("Gagal menyimpan pengaturan");
        }
    } catch (err) {
        console.error(err);
        alert("Terjadi kesalahan saat menghubungi server");
    }
}

    </script>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
